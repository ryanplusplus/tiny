name: Tests

on:
  push:
    branches:
      - main

  pull_request:

jobs:
  test:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04, ubuntu-latest, macos-latest]

    steps:
    - name: Install CppUTest
      uses: lyricwulf/abc@v1
      with:
        all: cpputest

    - uses: SimenB/github-actions-cpu-cores@v1
      id: cpu-cores

    - uses: actions/checkout@v3
      with:
        submodules: 'recursive'

    - name: Test on macOS
      if: matrix.os == 'macos-latest'
      run: CPATH="$CPATH:$(brew --prefix)/include" LIBRARY_PATH="$LIBRARY_PATH:$(brew --prefix)/lib" make -j${{ steps.cpu-cores.outputs.count }}

    - name: Test on Linux
      if: matrix.os != 'macos-latest'
      run: make -j${{ steps.cpu-cores.outputs.count }}
